class Barrier {
    int n;

    Barrier(int n) {
        this.n = n;
    }

    resource lock_invariant() = Perm(n, write);

    context Perm(n, write);
    void waitForBarrier() {
        lock this;
        n = n - 1;
        if (n == 0) {
            discharge_ob this;
            notify this;
        } else {
            discharge_ob this;
            while (n > 0) {
                wait this;
            }
        }
        unlock this;
    }
}